%canvas#canvas

%textarea#editor

#hoge
  %pre
    %code.lang-ruby#code
      :plain
        def hoge
        end

:coffee
  $ ->
    hljs.initHighlightingOnLoad()

    $('#editor').change ->
      $('#code').text($(@).val())
      hljs.highlightBlock($('#code')[0])
      $.get('/stylesheets/wip.css').complete (r) ->

        data = '<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">' +
               '<foreignObject width="100%" height="100%">' +
               '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size:15px">' +
               '<style type="text/css" >' +
               '<![CDATA[' +
               r.responseText +
               ']]>' +
               '</style>' +
               $('#hoge').html() +
               '</div>' +
               '</foreignObject>' +
               '</svg>'

        canvas = document.getElementById('canvas')
        ctx = canvas.getContext('2d')
        DOMURL = window.URL || window.webkitURL || window

        img = new Image()
        svg = new Blob([data], {type: 'image/svg+xml;charset=utf-8'})
        url = DOMURL.createObjectURL(svg)

        img.onload = ->
          ctx.drawImage(img, 0, 0)
          DOMURL.revokeObjectURL(url)

        img.src = url
